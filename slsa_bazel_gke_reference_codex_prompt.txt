
PROMPT FOR CODE GENERATOR (Run once on an empty repo)

Title: slsa-bazel-gke-reference — End‑to‑end SLSA L3+ secure software supply chain on Google Cloud with Bazel, GKE, Binary Authorization, Cosign, SBOMs, in‑toto, GUAC, and local-kind dev mode

You are an expert repository generator. Produce a COMPLETE, WORKING, WELL-DOCUMENTED monorepo in a SINGLE response. Do not summarize. Emit every file with its full content. After this single generation, a user should be able to run local dev (kind + local registry) OR deploy to GCP (Terraform → GKE) with SLSA provenance, SBOMs, signatures, and Binary Authorization policy enforcement.

## Non-negotiable requirements
- Create **~120+ files** across code, infrastructure, CI/CD, tests, docs. Include realistic code (not placeholders) with unit tests and basic e2e tests.
- Polyglot microservices (at least 5): 
  - `users` (Go + gRPC + REST via gRPC-Gateway), 
  - `orders` (Python/FastAPI), 
  - `inventory` (Java/Spring Boot), 
  - `payments` (Node/Express), 
  - `notifications` (Rust/Actix-web).
- A minimal React/TypeScript web UI `apps/web` that calls the gateway.
- Bazel as the unified build: WORKSPACE, MODULE.bazel, and BUILD files for each service (use rules_go, rules_python, rules_jvm/java, rules_node, rules_rust). Include `ibazel` dev workflow where applicable. Prefer Aspect Build rules where helpful.
- Containerization: Dockerfiles per service, multi-stage builds, and Bazel container rules.
- Kubernetes: Helm chart(s) (one umbrella chart + per-service subcharts) AND kustomize overlays (`dev`, `prod`).
- CI/CD: 
  - **Cloud Build** pipelines that (a) build with Bazel, (b) generate SLSA-compliant provenance, (c) generate SBOMs (CycloneDX + SPDX via `syft`), (d) sign images & attestations with **cosign** using **Cloud KMS**, (e) push to **Artifact Registry**, (f) run tests, (g) publish build & provenance to **Binary Authorization**; 
  - GitHub Actions workflows that run unit/e2e tests, lint, and local builds (for non-GCP users).
- Security & Policy: 
  - **Binary Authorization** policy and Continuous Validation config to enforce SLSA provenance & signature on GKE workloads.
  - **OPA Gatekeeper** policies (e.g., disallow :latest, require resource requests/limits, allowed registries, label ownership).
  - **in-toto** attestations emitted during build and verified pre-deploy.
- **GUAC** ingestion: deploy GUAC (via Helm or manifests) into the cluster; ingest SBOMs (CycloneDX/SPDX) and in‑toto/SLSA attestations; provide example GUAC queries.
- Observability: **OpenTelemetry** traces/metrics/logs wired through each service, with a local **OTEL Collector** and sample export (stdout + Prometheus scrape); add `/healthz` & `/readyz` endpoints.
- Dev UX:
  - Top-level `Makefile` with common tasks.
  - Devcontainer (`.devcontainer/`) for VS Code.
  - `docker-compose.yaml` for running all services + gateway + DB locally (Postgres preferred) WITHOUT Kubernetes.
  - Local **kind** cluster recipe with local registry mirror and `skaffold` config for inner-loop.
- Data:
  - Use Postgres with Bazel-managed migrations (e.g., `goose` or `flyway`) and seeded demo data.
- Testing:
  - Per-service unit tests, integration tests, plus a top-level e2e test that spins the web UI and hits core flows (create user → create order → adjust inventory → simulate payment → notification).
- Documentation: 
  - **docs/** with architecture diagram(s) (Mermaid or PlantUML), threat model, step-by-step GCP deploy guide, local dev guide, SLSA/attestation explainer, SBOM usage, GUAC querying, troubleshooting, design decisions, and contribution guide.
  - All READMEs must be runnable and accurate. Include command snippets that actually exist.
- Licenses: Apache-2.0 license at repo root; NOTICE file.

## Repository name & top-level structure
Repository name: **slsa-bazel-gke-reference**

Top-level tree (illustrative; expand as needed — ensure 120+ total files):
.
├─ apps/
│  └─ web/                 # React/TS web UI + Bazel + Dockerfile + unit tests
├─ services/
│  ├─ users/               # Go service (gRPC + REST via grpc-gateway)
│  ├─ orders/              # Python FastAPI
│  ├─ inventory/           # Java Spring Boot
│  ├─ payments/            # Node/Express
│  └─ notifications/       # Rust Actix-web
├─ api/
│  ├─ proto/               # .proto files, Bazel rules, generated stubs
│  └─ gateway/             # Go gateway bridging REST ↔ gRPC
├─ infra/
│  ├─ terraform/           # GCP: projects, KMS, AR, GKE, Cloud Build, Binary Auth, Secret Manager, IAM
│  ├─ k8s/
│  │  ├─ base/             # Deployments, Services, HPAs, PodDisruptionBudgets
│  │  ├─ overlays/dev/
│  │  └─ overlays/prod/
│  └─ helm/                # umbrella + subcharts (services, otel, guac)
├─ supply-chain/
│  ├─ cosign/              # cosign policies, key refs (KMS URIs), verification scripts
│  ├─ slsa/                # provenance schema samples, verifiers
│  ├─ intoto/              # in-toto layouts and link metadata
│  └─ sbom/                # SBOM generation (syft), sample outputs, verification
├─ ci/
│  ├─ cloudbuild/          # cloudbuild.yaml for each service + monorepo orchestrator
│  └─ github/              # GitHub Actions workflows (build, test, lint)
├─ tools/                  # helper CLIs (Go) for verifying attestations, querying GUAC, etc.
├─ .devcontainer/
├─ .vscode/
├─ third_party/            # Bazel external deps (if vendored), rules sets
├─ docs/
│  ├─ 00-architecture.md
│  ├─ 01-local-dev.md
│  ├─ 02-gcp-deploy.md
│  ├─ 03-slsa-binary-auth.md
│  ├─ 04-sbom-and-guac.md
│  ├─ 05-opa-gatekeeper.md
│  ├─ 06-observability.md
│  ├─ 07-testing-e2e.md
│  └─ 08-troubleshooting.md
├─ WORKSPACE
├─ MODULE.bazel
├─ BUILD.bazel (root)
├─ Makefile
├─ skaffold.yaml
├─ docker-compose.yaml
├─ LICENSE
└─ README.md

## Key implementation details (must-do)
1) **Bazel**:
   - Set up Bazel modules and WORKSPACE with rules for Go, Python, Java, Node, and Rust. Provide example targets and `bazel query` examples.
   - Provide `ibazel` hot-reload for Go and Node where feasible.
   - Use reproducible builds and pin toolchains.
2) **Proto & Gateway**:
   - Define core domain API (`users`, `orders`, `inventory`, `payments`, `notifications`) in `api/proto/*.proto` with versioning. Generate stubs for Go (gateway) and clients in other services as needed.
3) **Datastore**:
   - Shared Postgres schema; each service has its own schema/user. Provide migrations and seed data. Include `bazel` targets to run migrations.
4) **Security pipeline**:
   - Cloud Build config that builds containers with Bazel, produces **SLSA-compliant provenance**, creates SBOMs via `syft`, signs images and attestations via **cosign** using **Cloud KMS** keys, pushes to Artifact Registry, and registers attestations for **Binary Authorization** gate.
   - Provide sample **Binary Authorization** policy and **Continuous Validation** config that rejects unsigned/unattested images.
5) **in-toto & SLSA**:
   - Add in‑toto layout describing build/test/scan steps. Produce `link` metadata in CI. Provide a verifier script that runs before deploy.
6) **GUAC**:
   - Deploy GUAC in-cluster (Helm). After builds, publish SBOMs and attestations to a bucket/reg/URL that GUAC ingests. Provide example GUAC queries (e.g., “which runtime images include a vulnerable dependency?”).
7) **Observability**:
   - OpenTelemetry SDKs in each service; collector config; export traces/metrics locally and on GKE.
8) **Policies (OPA Gatekeeper)**:
   - ConstraintTemplates + Constraints to enforce no `:latest`, resource limits, restricted registries, and mandatory labels/annotations.
9) **Local dev**:
   - `docker-compose up` runs all services + Postgres + OTEL + gateway + web.
   - `make kind-up` creates a kind cluster with a local registry mirror; `skaffold dev` syncs changes.
10) **Docs**:
   - Exact step-by-step commands that work on macOS/Linux with minimal prerequisites (Docker, Bazelisk, gcloud, terraform). Call out GCP costs and clean-up steps.
11) **Tests & sample data**:
   - Provide unit tests in each language and a top-level e2e that exercises the “happy path” via the gateway and verifies persistence & notifications.

## Cloud specifics (GCP)
- Terraform provisions: project, Artifact Registry (regional), KMS (asymmetric signing key), GKE Autopilot or Standard cluster, Workload Identity, service accounts, IAM bindings, Secret Manager for DB creds & API keys, Cloud Build triggers, Binary Authorization policy & attestors, Pub/Sub for notifications (optional), Cloud Storage for SBOM/provenance artifacts.
- Cloud Build prov: pipeline to run Bazel builds/test, emit SLSA provenance, run `syft` SBOMs, generate in‑toto attestations, cosign sign & attest (KMS), push to AR, update GUAC ingest location, and finally `kubectl apply` through a gated stage that verifies Binary Authorization.

## Local “no cloud” mode
- Fully runnable via `docker-compose` and via `kind + skaffold` (document both). Use a local registry mirror. Provide a `scripts/dev-seed.sh` to create users/items and place a test order.

## Output formatting (VERY IMPORTANT)
- Emit the whole repo as a sequence of files with clear path headers, like:

<<<FILE: README.md>>>
# slsa-bazel-gke-reference
…full markdown content…
<<<END FILE>>>

<<<FILE: services/users/main.go>>>
package main
…full code…
<<<END FILE>>>

- Do this for **EVERY** file. No ellipses. No placeholders like “TODO”. All code must compile/run.
- Ensure shell scripts are `#!/usr/bin/env bash` with `set -euo pipefail` and are executable (`chmod +x` instruction in README).
- Keep line lengths reasonable; provide comments explaining key design choices.

## Minimal acceptance checklist (must pass)
- `make compose-up` → all services healthy; web works at http://localhost:3000
- `make kind-up && skaffold dev` → deploys to kind; gateway responds; e2e passes
- `terraform apply` (after `gcloud auth application-default login` and project set) → creates GCP infra
- Pushing a commit triggers **Cloud Build**; images pushed to **Artifact Registry**; **SBOM** + **SLSA** provenance artifacts generated; **cosign** signatures & **in‑toto** attestations produced; **Binary Authorization** policy allows only signed + SLSA-provenanced images; GUAC ingests and can answer example queries
- `bazel test //...` passes

## Documentation pages (write them in docs/)
- 00-architecture.md — include Mermaid diagrams for request flow & CI/CD + security pipeline
- 01-local-dev.md — docker-compose & kind flows
- 02-gcp-deploy.md — Terraform & Cloud Build setup, service accounts, KMS, AR, GKE, Binauthz
- 03-slsa-binary-auth.md — what SLSA provenance is, how Cloud Build emits it, how Binauthz checks it
- 04-sbom-and-guac.md — syft, CycloneDX/SPDX, GUAC ingest & example queries
- 05-opa-gatekeeper.md — constraints explained + how to extend
- 06-observability.md — OTEL setup, collector config, where to view traces/metrics
- 07-testing-e2e.md — how tests are structured and how to add more
- 08-troubleshooting.md — common issues & fixes

## Quality bars
- Idiomatic code in each language; lint configs included (golangci-lint, flake8/ruff, eslint, rustfmt, spotless for Java).
- Clear commit-ready content; sample data; consistent naming; helpful comments.
- Keep secrets out of the repo; reference Secret Manager / `.env.example`.

Now generate the entire repository, printing every file as:
<<<FILE: relative/path>>> … <<<END FILE>>>
